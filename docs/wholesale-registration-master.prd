# Lightspeed Wholesale â€” Feature PRD Index

**Version:** 2.0
**Owner:** Keryx Solutions
**Status:** Active
**Last Updated:** 2025-11-11

---

## Overview

This document serves as an index to the individual Product Requirement Documents (PRDs) for the Lightspeed Wholesale storefront app. The app has been split into four focused feature PRDs to support independent development, modularization, and potential extraction into separate Ecwid apps.

---

## Feature PRDs

### 1. Wholesale Registration
**File:** [registration.prd](./registration.prd)

**Summary:** Account-based wholesale registration flow integrated into Ecwid's `/products/account/register` page. Prefills customer data from storefront, submits to external **Registration Server** using session token authentication. Server handles all Admin REST operations (profile updates, extra fields persistence, immediate group assignment).

**Current Status:** âœ… Complete â€” External server architecture with full persistence

**Architecture:** Client-Server
- **Client:** Form rendering, validation, session token auth
- **Server:** Admin REST operations, group assignment, idempotency

**Key Features:**
- Custom registration form injection on account pages
- Prefill from `Ecwid.Customer.get()`
- Submit to external Registration Server at `REG_SERVER_URL/api/register`
- Session token authentication (Bearer token)
- Idempotency support with `Idempotency-Key` header
- Server handles: profile updates, extra fields, group assignment
- Extra field UI metadata from `Ecwid.getAppPublicConfig(clientId)["extraFields"]`
- Telemetry tracking

---

### 2. Wholesale Gating (Price Visibility)
**File:** [wholesale-gating.prd](./wholesale-gating.prd)

**Summary:** Hide product prices, buy buttons, and price filters for guests and non-wholesale customers. Show full e-commerce functionality only for logged-in wholesale group members.

**Current Status:** âœ… Complete and Production-Ready

**Key Features:**
- Client-side price hiding via CSS injection
- Storefront config toggles (`show_price_on_items`, `show_buy_button`)
- Wholesale membership detection via `Ecwid.Customer.get()`
- SPA-aware navigation handling
- Session caching to prevent flicker

---

### 3. Category Banners
**File:** [category-banners.prd](./category-banners.prd)

**Summary:** Display full-width hero banners on category pages using category featured images with description text overlays.

**Current Status:** âœ… Complete and Production-Ready

**Key Features:**
- Full-width image backgrounds from category data
- Rich text description overlays
- Fetches via Ecwid REST API (`/categories/{id}`)
- Responsive design with external CSS
- Requires "Hide category names" design setting

---

### 4. Product Tags
**File:** [product-tags.prd](./product-tags.prd)

**Summary:** Display product tags from TAGS attributes as styled pill-shaped links below product descriptions.

**Current Status:** âœ… Phase 1 Complete (display only) | ðŸ”„ Phase 2 Pending (tag landing pages and filtering)

**Key Features:**
- Fetch product attributes via Ecwid REST API
- Render tags with hover effects
- Placeholder link behavior (alert)
- Future: tag landing pages and search integration

---

## Cross-Cutting Concerns

### Shared Utilities
The following utilities are used across multiple features and should be maintained as shared dependencies:

- **`waitForEcwidAndTokens()`** â€” Ensures Ecwid API readiness and returns store ID + public token
- **`getStorefrontSessionToken()`** â€” Retrieves session token for external API authentication (Registration feature)
- **`trackWholesaleEvent(name, props)`** â€” Telemetry tracking with deduplication
- **`isAccountRegisterPath()`** â€” Detects registration route
- **`removeNodeById(id)`** â€” Safe node removal

### Configuration
- **App Client ID:** `custom-app-121843055-1`
- **Wholesale Group Name:** `window.WHOLESALE_GROUP_NAME` (default: `"Wholesaler"`)
- **Registration Server URL:** `window.WHOLESALE_REG_SERVER_URL` (default: `"https://ecwid-registration.keryx-solutions.workers.dev"`)
- **Feature Flags:** `WHOLESALE_FLAGS.ENABLE_WHOLESALE_REGISTRATION`, `WHOLESALE_FLAGS.ENABLE_WHOLESALE_BANNER`

### Required Ecwid Scopes

**Client-Side (Storefront App):**
- `read_catalog` â€” For fetching categories and products (banners, tags)
- `read_customers` â€” For customer profile access and prefill (registration, gating)
- `read_customer_groups` â€” For wholesale membership detection (gating)
- `read_store_profile` â€” For store configuration

**Server-Side (Registration Server):**
- `read_customers` â€” For customer identity verification
- `update_customers` â€” For profile updates and group assignment
- `read_customer_groups` â€” For resolving wholesale group ID
- `read_store_extrafields` â€” For extra field key resolution (if using extra fields)

**Note:** Client no longer requires `update_customers` scope â€” all updates handled by Registration Server via Admin REST API.

---

## Implementation Architecture

### Current State (Monolithic)
All features are implemented in a single file:
- **`app.js`** â€” All four features as separate initialization functions
- **`app.css`** â€” Shared styles for banners, tags, and forms
- **Deployment:** GitHub Pages static hosting

### Initialization Flow
```javascript
Ecwid.OnAPILoaded.add(function() {
  initializeWholesalePriceVisibility();  // Gating feature
  initializeCategoryBanner();             // Category banners
  initializeProductTagSystem();           // Product tags
  initializeWholesaleRegistration();      // Registration flow
});
```

### SPA Navigation Handling
All modules hook into:
- `Ecwid.OnAPILoaded.add(callback)` â€” Initial app load
- `Ecwid.OnPageLoaded.add(callback)` â€” SPA page transitions

---

## Future Modularization Path

### Extraction Strategy
Each feature can be extracted into a standalone Ecwid app:

1. **Extract shared utilities** into a common library or npm package
2. **Create separate `app.js` files** per feature
3. **Package as individual Ecwid apps** with own manifests
4. **Coordinate via shared conventions:**
   - Consistent group naming (`WHOLESALE_GROUP_NAME`)
   - Shared telemetry format
   - Coordinated CSS class naming

### Benefits of Separation
- Independent release cycles per feature
- Easier testing and debugging
- Merchants can enable/disable features individually
- Reduced bundle size for merchants using subset of features
- Clearer ownership and maintenance boundaries

---

## Testing Strategy

### Manual Testing Checklist (All Features)
After any changes, verify:
- [ ] Category pages show banner with image and overlay (requires image + description)
- [ ] Product pages show tags (requires TAGS attribute values)
- [ ] Guests see no prices or buy buttons
- [ ] Logged-in non-wholesale users see prices hidden and registration banner
- [ ] Logged-in wholesale users see prices and no banner
- [ ] `/products/account/register` loads form with prefilled data
- [ ] Form submission saves customer data (check Network tab)
- [ ] Console shows no errors during navigation
- [ ] All telemetry events fire correctly

### Automated Testing (Future)
- **Unit tests:** Routing helpers, extra field normalization, telemetry deduplication
- **Integration tests:** API mocking, DOM injection, SPA navigation
- **E2E tests (Playwright):** Full user flows on staging store

---

## Deployment Process

### Current Deployment
1. Update `app.js` or `app.css` locally
2. Commit and push to GitHub (triggers GitHub Pages deployment)
3. Test on staging store
4. Promote to production via Ecwid app admin

### Rollback Plan
- Revert commit and push to GitHub
- GitHub Pages deploys previous version automatically
- Changes reflected in stores within 5 minutes (CDN cache)

---

## Telemetry Events

### Registration Feature
- `wholesale_banner_shown`, `wholesale_banner_click`
- `wholesale_registration_view`, `wholesale_registration_submit`
- `wholesale_registration_success`, `wholesale_registration_failure`

### Gating Feature (Recommended)
- `wholesale_gating_applied` â€” Prices hidden
- `wholesale_gating_removed` â€” Prices shown
- `wholesale_gating_error` â€” API failure

### Category Banners (Recommended)
- `category_banner_view`, `category_banner_error`

### Product Tags (Recommended)
- `product_tags_view`, `product_tag_click`, `product_tags_error`

---

## Documentation Structure

```
docs/
â”œâ”€â”€ wholesale-registration-master.prd  # This index file
â”œâ”€â”€ registration.prd                   # Wholesale registration flow
â”œâ”€â”€ wholesale-gating.prd               # Price visibility control
â”œâ”€â”€ category-banners.prd               # Category hero banners
â”œâ”€â”€ product-tags.prd                   # Product tag display
â”œâ”€â”€ exploration.md                     # Technical research notes
â”œâ”€â”€ exploration_extrafields.md         # Extra fields implementation research
â””â”€â”€ IMPLEMENTATION_SUMMARY.md          # Implementation history
```

---

## References

### Ecwid Documentation
- **Storefront JS API:** https://docs.ecwid.com/storefronts
- **REST API Reference:** https://docs.ecwid.com/api-reference/rest-api
- **OnPageLoaded Events:** https://docs.ecwid.com/storefronts/track-storefront-events/page-is-loaded-events
- **Customer Management:** https://docs.ecwid.com/storefronts/manage-customers-on-the-storefront
- **App Settings:** https://docs.ecwid.com/develop-apps/app-settings

### Project Documentation
- **README.md** â€” Feature overview and deployment checklist
- **CLAUDE.md** â€” Development guide for Claude Code
- **TESTING_STRATEGY.md** â€” Browser console test scenarios

---

## Open Questions and Future Enhancements

### Shared Across Features
- **App Storage Contract:** Standardize `Ecwid.getAppPublicConfig(clientId)` vs `Ecwid.getAppStorageData("public", key)` usage
- **Telemetry Backend:** Implement server-side telemetry collection for analytics
- **Error Reporting:** Add Sentry or similar for production error tracking

### Registration-Specific
- Cell Phone mapping: extra field only or also `contacts[].type=MOBILE`?
- Country list expansion beyond US territories
- Multi-step registration flow for complex onboarding

### Gating-Specific
- Product-level gating (hide specific products from non-wholesale)
- Custom "Login to see prices" messaging
- Wholesale pricing tiers by customer group

### Category Banners
- Video background support
- Parallax scrolling effects
- Multiple images/carousel

### Product Tags
- Tag landing pages (`/tag/{slug}`)
- Multi-tag filtering
- Tag cloud widget
- Tag analytics and popularity indicators

---

## Version History

### Version 2.1 (2025-11-11)
- **Migration to External Registration Server**
- Replaced storefront `/customer/update` submission with external server architecture
- Client now authenticates with session token (Bearer)
- Server handles all Admin REST operations:
  - Customer profile updates (`billingPerson`, `acceptMarketing`, `taxId`, `contacts`)
  - Customer extra fields persistence (Tax ID, Cell Phone, referral source)
  - Immediate customer group assignment
- Added idempotency support with `Idempotency-Key` header
- Removed client-side checkout discovery fallback (App Storage only for UI metadata)
- Updated all PRDs and documentation to reflect new architecture
- Benefits: Unified persistence, immediate group assignment, better security, simplified client

### Version 2.0 (2025-11-11)
- Split master PRD into four focused feature PRDs
- Added cross-cutting concerns documentation
- Clarified current vs target state for each feature
- Documented future modularization path

### Version 1.1 (2025-10-28)
- Removed custom backend/proxy server
- Switched to storefront-only approach
- Registration integrated into `/products/account/register`
- Uses Storefront `customer/update` endpoint with session cookies
- Group assignment via Ecwid Automations/Webhooks

### Version 1.0 (Initial)
- Original monolithic PRD covering all features
- Admin REST API approach (later deprecated)

---

**For detailed specifications, acceptance criteria, and implementation notes, please refer to the individual feature PRDs linked above.**

# Lightspeed eCom (Ecwid) — Wholesale Registration Flow — Master PRD

Version: 1.1
Owner: Keryx Solutions
Status: Draft
Date: 2025-10-28

## 1) Summary
Enable a wholesale registration flow that restricts price visibility and ordering to customers in the "Wholesaler" group. A global banner prompts logged‑in non‑wholesale users to register. The form pre-populates from the logged‑in profile and saves via the Storefront `customer/update` endpoint with credentials included. Group assignment is handled by Ecwid Automations/Webhooks server‑side. Existing price-visibility code is reused.

Docs reference:
- Storefront JS overview: https://docs.ecwid.com/storefronts
- JS API calls index (events, customer): https://docs.ecwid.com/api-reference/advanced/js-api-calls
- OnPageLoaded event: https://docs.ecwid.com/storefronts/track-storefront-events/page-is-loaded-events
- Get logged-in customer (JS): https://docs.ecwid.com/storefronts/manage-customers-on-the-storefront/get-logged-in-customers-details
- REST Update customer: https://docs.ecwid.com/api-reference/rest-api/customers/update-customer
- REST Get customer: https://docs.ecwid.com/api-reference/rest-api/customers/get-customer
 - App settings (tokens & scopes): https://docs.ecwid.com/develop-apps/app-settings

### Summary Update (v1.1)
- Registration is implemented in-place on `/products/account/register` (no standalone `/wholesale-registration` page).
- Storefront-only approach: use Ecwid Storefront JS (e.g., `Ecwid.Customer.get`) and `POST https://app.ecwid.com/storefront/api/v1/{storeId}/customer/update`.
- No Admin REST calls on the storefront; no custom proxy server.
- Customer Extra Fields are sourced from Storefront state (`ec.order.extraFields`) with a fallback discovery via `customer/update` response.
- If we can't assing the wholesale group through the endpoint, wholesale group assignment is performed by Ecwid Automations/Webhooks after save (e.g., when a valid Tax ID is present).

## 2) Constraints & Current State
- Only `app.js` and `app.css` are auto-loaded by Lightspeed; all storefront logic must live there.
- Current repo already gates price visibility by login plus membership in the `Wholesaler` group; new accounts without this group do not see prices.
- Category banner and product tags systems exist and must not regress.

## 3) Goals
- Gate wholesale access (prices + ordering) behind membership in the `Wholesaler` group.
- Smooth UX: immediate redirect for logged‑in non‑wholesale users; clear banner elsewhere.
- Server-side secure updates to customer data and group assignment.
- No regressions to existing features.

## 4) Non‑Goals
- Manual approval workflows and document uploads.
- Multiple wholesale tiers.
- Multi-language (initially English only).

## 5) User Flow
1. User logs in via the standard Ecwid process.
2. Frontend evaluates membership via Storefront JS (`Ecwid.Customer.get`) where possible.
3. Logged‑in, non‑wholesale users see a banner linking to `/products/account/register`.
4. On `/products/account/register`, a prefilled registration form is injected into the account page container.
5. Submit form → call Storefront `customer/update` to save `updatedCustomer` and extra fields (requires bearer token in header, which can be found in the cookie `ec-[store_id]-session`, eg `ec-121843055-session`).
6. Ecwid Automations/Webhooks (server-side) assign the wholesale group upon validation.
7. Storefront config refreshes to reflect updated state; navigation remains on the account area.

## 6) Functional Requirements
- **FR‑1 Login & Detection**
  - Use `Ecwid.OnAPILoaded` and `Ecwid.OnPageLoaded` to run checks on initial load and each SPA navigation.
  - Use `Ecwid.Customer.get(cb)` to detect login and obtain `customer.id`, `customer.email`, and `billingPerson` fields for prefill.
- **FR‑2 Wholesale Status Check (Storefront-only)**
  - Determine membership primarily from Storefront JS (`customer.membership`), avoiding Admin REST calls.
- **FR‑3 Navigation**
  - No auto‑redirect. Show a banner for logged‑in, non‑wholesale users linking to `/products/account/register`.
- **FR‑4 Banner**
  - Show a persistent banner on all pages except the account/register view.
  - Copy: `Register to access prices and place an order.` Link: `/products/account/register`.
- **FR‑5 Registration Form (fields and mapping)**
  - Email (required, display‑only, read‑only UI) → prefilled from `Ecwid.Customer.get`; used for identity verification only; not updated. Render as non-editable (readonly/disabled input or static text).
  - Name (required) → `billingPerson.name`
  - Country (required, ISO 3166‑1 alpha‑2) → `billingPerson.countryCode`
  - Company name (required) → `billingPerson.companyName`
  - Postal code (required) → `billingPerson.postalCode`
  - Phone (required) → `billingPerson.phone`
  - Cell phone (optional) → Customer Extra Field titled `Cell Phone` (see FR‑6)
  - Tax ID (required) → Customer Extra Field titled `Tax ID` (see FR‑6)
  - How did you hear about us? (optional) → Customer Extra Field titled `How did you hear about us?` (see FR‑6)
  - Newsletter signup (checkbox) → `acceptMarketing` (boolean)
- **FR‑6 Customer Extra Fields (align with importer)**
  - Prefer Storefront state for checkout/extra field definitions; fallback to `customer/update` response `checkoutSettings.extraFields`.
  - Use titles matching the migration tool:
    - `Tax ID`
    - `How did you hear about us?`
    - `Cell Phone` (new, optional)
  - On submit, call Storefront `customer/update` to update `updatedCustomer` and provide `checkout.extraFields` data for persistence.
- **FR‑7 Group Assignment**
  - Performed by Ecwid Automations/Webhooks (server-side) after data validation; no client-side `customerGroupId` updates.
  - After saving, refresh storefront config so visibility updates promptly (`Ecwid.refreshConfig()`).
- **FR‑8 Success Redirect**
  - User is redirected to store frontpage `/products`. An info banner is displayed showing that the user was successfully registered.
- **FR‑9 Registration Page Price State**
  - Registration runs under the account area; no dedicated price-hiding page is required. Existing visibility logic remains in effect.
- **FR‑10 Error Handling**
  - If Ecwid REST API validation or calls fail, show inline error and remain on the registration page; do not assign group.

## 7) Technical Design
- **7.1 Frontend (app.js)**
  - Add `initializeWholesaleRegistration()` module:
    - Hooks `Ecwid.OnAPILoaded` and `Ecwid.OnPageLoaded`.
    - Determines membership from Storefront JS (`customer.membership`).
    - Injects a banner on all pages (existing) except the account/register (new) view.
    - Renders registration form at `/products/account/register`, pre-populates from `Ecwid.Customer.get`.
    - After save: call `Ecwid.refreshConfig()` so prices update promptly.
    - CSS in `app.css` for `.wholesale-registration-banner` and `.wholesale-registration-form`.
    - Do not regress existing modules (price visibility, category banner, tag system).

- **7.2 Removed in v1.1: Server Proxy for Admin REST**
  - No custom proxy server is used. Admin REST calls are not executed from the storefront.

 - **7.3 Data Model Mapping**
  - Core (from registration form):
    - `billingPerson.name`
    - `billingPerson.companyName`
    - `billingPerson.countryCode`
    - `billingPerson.postalCode`
    - `billingPerson.phone`
    - `acceptMarketing`
  - Custom (Customer Extra Fields via `extraFields`):
    - `Tax ID`
    - `How did you hear about us?`
    - `Cell Phone` (optional)
  - Group assignment:
    - `customerGroupId` → `WHOLESALE_GROUP_ID` (resolved by name and cached)

- **7.4 Routing**
  - Registration path: `/products/account/register` (hash-compatible if needed).
  - No required redirect after save.

- **7.5 Banner Behavior**
  - Show on all pages except `/products/account/register`.
  - Copy: `Register to access prices and place an order.`
  - Hide banner for customers already in the wholesale group.

## 8) Validation & Error Handling
- Frontend must match Ecwid storefront patterns (checkout/account UI):
  - Labeling: All fields are required unless explicitly marked "(optional)". Do not use asterisks. Optional labels appear as part of the field title (e.g., "Phone (optional)", "Company name (optional)").
  - Error presentation: Apply a red border and light red background to the control and render an inline message beneath it. Add `form-control--error` to the control wrapper and a message element `<div class="form__msg form__msg--error" id="[field-id]-msg">…</div>`. Connect via `aria-describedby="[field-id]-msg"`. See exploration snippet for structure.
  - Submission: Keep the Submit/Continue button enabled. On click, block submission, focus/scroll to the first invalid field, and show inline errors. Preserve all entered values.
  - Field checks: name non-empty; country is a valid ISO‑2 code; postal code non-empty; tax ID non-empty; phone validated only if provided (optional); other optional fields skipped if empty.
  - Accessibility: set `aria-invalid="true"` on invalid inputs/selects; associate errors via `aria-describedby`; use an `aria-live="polite"` region if a summary banner is shown.
- Server validation mirrors client, verifies identity, and rejects invalid payloads (fail‑fast on identity mismatch).
- Network failures: show error inline, preserve entered values, allow retry.

## 9) Accessibility & i18n
- Labels tied to inputs; full keyboard navigation.
- Errors announced to screen readers.
- English copy centralized for future localization.

## 10) Telemetry
- Events:
  - `wholesale_banner_shown`, `wholesale_banner_click`
  - `wholesale_registration_view`, `wholesale_registration_submit`, `wholesale_registration_success`, `wholesale_registration_failure`

## 11) Testing
- **Unit tests (jsdom + Vitest/Jest)**
  - [U1] Routing helpers: `isAccountRegisterPath`, `toAccountRegisterPath` — correct detection/URLs.
  - [U2] Extra fields: `normalizeExtraDefs(map)` — maps Tax ID, How did you hear…, Cell Phone; resilient to missing keys/titles.
  - [U3] Error rendering helper: invalid field adds `form-control--error` to control wrapper, sets `aria-invalid="true"`, links message via `aria-describedby="[id]-msg"`, and renders `<div class="form__msg form__msg--error" id="[id]-msg">…</div>`.
  - [U4] Visibility helpers: inject/remove `#wholesale-hide-css` correctly when toggling logged-in state.
  - [U5] Telemetry: `trackWholesaleEvent` deduplicates by key and logs once per unique payload.
- **Integration/E2E (Playwright on staging store)**
  - [I1] Banner: shows for logged‑in non‑wholesale users; hidden for guests and approved wholesale.
  - [I2] Registration page: at `/products/account/register` injects form into `.ec-cart__body-inner`, prefilled from `Ecwid.Customer.get`.
  - [I3] Validation: with required fields empty, submission blocks, first invalid field receives focus, and error UI matches spec (`form-control--error` + inline message).
  - [I4] Submit success: calls `storefront/api/v1/{storeId}/customer/update`, preserves entered values, then `Ecwid.refreshConfig()` is invoked.
  - [I5] Price visibility toggles appropriately when logging in/out.
  - [I6] Telemetry events fired on view, submit, success, failure.
- **Accessibility checks**
  - [A1] Invalid inputs have `aria-invalid="true"` and messages linked via `aria-describedby`.
  - [A2] Optional summary region (if present) uses `aria-live="polite"`. Keyboard focus moves to the first invalid control.
- **Test environment**
  - Use a staging store with seeded test users (guest, logged‑in non‑wholesale, wholesale). Mock Ecwid APIs for unit tests; avoid real network.
- **CI**
  - Run unit tests on every PR. Nightly Playwright smoke on staging: banner visible (non‑wholesale), register form renders, one validation failure path, one successful submit.

## 12) Security & Privacy
- All PII submitted via HTTPS only.
- Verify customer identity via Ecwid (`GET /customers/{id}`) before updates.
- Admin tokens never exposed to the browser.
- CSRF protection and rate limiting applied if any intermediary app/server is used to invoke Admin REST calls.

## 13) Rollout Plan
- Environments: staging → production.
- Backward compatible with existing visibility logic.

## 14) Acceptance Criteria
- **AC‑1** Guest users: prices hidden; banner visible; Register link works.
- **AC‑2** Logged‑in, non‑wholesale: auto‑redirect to `/wholesale-registration`.
- **AC‑3** On `/wholesale-registration`, prices/buy buttons remain hidden.
- **AC‑4** Registration save updates `billingPerson`, `acceptMarketing`, Customer Extra Fields (Tax ID, How did you hear about us?, Cell Phone), and assigns wholesale group.
- **AC‑5** After success, redirect to `/products`; prices visible per existing logic.
- **AC‑6** Logged‑in wholesale users: no redirect, no banner.
- **AC‑7** Errors shown inline; no partial/inconsistent state.

## 15) Open Questions
- Confirm wholesale group exact name vs using only group ID (PRD recommends ID with name fallback lookup/caching).
- Should we auto-set `taxExempt = true` upon wholesale assignment (importer does this heuristically)?
- Do we also add a secondary PHONE contact for cell number (in addition to extra field), or keep cell strictly as an extra field?

## 16) References
- `app.js`, `app.css` in this repo
- Ecwid Storefront docs and REST API (links above)
- Importer script used for alignment: `esprit-creations/migration/customers_import.py` (Customer Extra Fields titles and update pattern)
